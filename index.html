<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <style>
        .img-100vh {
            max-height: 100vh;
        }

        .img-max {
            max-height: unset;
        }
    </style>
</head>

<body>
    <div class="collapse" id="collapseNavBar">
        <nav class="navbar navbar-expand-lg navbar-light fixed-top bg-light">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">Navbar</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false"
                    aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="navbar-nav">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="flexSwitchCheckDefault">
                        <label class="form-check-label" for="flexSwitchCheckDefault">Full Size</label>
                    </div>
                </div>
            </div>
        </nav>
    </div>
    <div class="container-fluid">
        <div id="myCarousel" class="carousel slide lazy-load" data-bs-interval="false" data-bs-ride="carousel">
            <div class="carousel-inner">
                <div class="carousel-item active">
                    <div class="d-flex flex-row-reverse justify-content-center">
                        <img src="hafs/2.png" alt="2">
                        <img src="hafs/1.png" alt="1">
                    </div>
                </div>
            </div>
            <a class="carousel-control-next" href="#myCarousel" role="button" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Next</span>
            </a>
            <a class="carousel-control-prev" href="#myCarousel" role="button" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Previous</span>
            </a>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW"
        crossorigin="anonymous"></script>
    <script>
        //building page
        let inner = "";
        for (let i = 604; i > 2; i = i - 2) {
            inner += `
            <div class="carousel-item">
                <div class="d-flex flex-row-reverse justify-content-center d-inline-block">
                    <img src="hafs/frame.jpg" class="img-page" data-src="hafs/${i}.png" alt="${i}">
                    <img src="hafs/frame.jpg" class="img-page" data-src="hafs/${i - 1}.png" alt="${i - 1}">
                </div>
            </div>`;
        }
        inner += `
            <div class="carousel-item active">
                <div class="d-flex flex-row-reverse justify-content-center">
                    <img src="hafs/2.png" class="img-page" alt="2">
                    <img src="hafs/1.png" class="img-page" alt="1">
                </div>
            </div>`;
        document.querySelector('.carousel-inner').innerHTML = inner;

        //lazy load
        document.getElementById('myCarousel').addEventListener('slide.bs.carousel', function (event) {
            event.relatedTarget.querySelectorAll('div > img').forEach(element => {
                if (element.dataset.src) {
                    element.setAttribute('src', element.dataset.src);
                    element.removeAttribute('data-src');
                }
            });
        });

        //view size
        document.getElementById("flexSwitchCheckDefault").addEventListener("change", () => {
            let newClass = document.querySelector('.img-page').className == "img-page img-100vh" ?
                "img-page img-max" : "img-page img-100vh";
            document.querySelectorAll('.img-page').forEach(element => {
                element.className = newClass;
            });

        })

        // middle click
        document.querySelector('.carousel-inner').addEventListener('click', () => {
            //full screen on click
            let elem = document.documentElement;
            if (elem.requestFullScreen) {
                elem.requestFullScreen();
            } else if (elem.mozRequestFullScreen) {
                elem.mozRequestFullScreen();
            } else if (elem.webkitRequestFullScreen) {
                elem.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT);
            } else if (elem.msRequestFullscreen) {
                elem.msRequestFullscreen();
            }
            //show hide navBar
            let cNavBar = document.getElementById('collapseNavBar');
            cNavBar.className = cNavBar.className == "collapse" ? "collapse show" : "collapse";
        });



        (function () {
            // IndexedDB
            var indexedDB = window.indexedDB || window.webkitIndexedDB || window.mozIndexedDB || window.OIndexedDB || window.msIndexedDB,
                IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction || window.OIDBTransaction || window.msIDBTransaction,
                dbVersion = 1.0;

            // Create/open database
            var request = indexedDB.open("pagesFiles", dbVersion),
                db,
                createObjectStore = function (dataBase) {
                    // Create an objectStore
                    console.log("Creating objectStore");
                    dataBase.createObjectStore("pages");
                },

                getImageFile = function () {
                    // Create XHR
                    var xhr = new XMLHttpRequest(),
                        blob;

                    xhr.open("GET", "hafs/1.png", true);
                    // Set the responseType to blob
                    xhr.responseType = "blob";

                    xhr.addEventListener("load", function () {
                        if (xhr.status === 200) {
                            console.log("Image retrieved");

                            // Blob as response
                            blob = xhr.response;
                            console.log("Blob:" + blob);

                            // Put the received blob into IndexedDB
                            putpageInDb(blob);
                        }
                    }, false);
                    // Send XHR
                    xhr.send();
                },

                putpageInDb = function (blob) {
                    console.log("Putting pages in IndexedDB");

                    // Open a transaction to the database
                    var transaction = db.transaction(["pages"], IDBTransaction.READ_WRITE);

                    // Put the blob into the dabase
                    var put = transaction.objectStore("pages").put(blob, "image");

                    // Retrieve the file that was just stored
                    transaction.objectStore("pages").get("image").onsuccess = function (event) {
                        var imgFile = event.target.result;
                        console.log("Got page!" + imgFile);

                        // Get window.URL object
                        var URL = window.URL || window.webkitURL;

                        // Create and revoke ObjectURL
                        var imgURL = URL.createObjectURL(imgFile);

                        // Set img src to ObjectURL
                        var imgpage = document.getElementById("page");
                        imgpage.setAttribute("src", imgURL);

                        // Revoking ObjectURL
                        URL.revokeObjectURL(imgURL);
                    };
                };

            request.onerror = function (event) {
                console.log("Error creating/accessing IndexedDB database");
            };

            request.onsuccess = function (event) {
                console.log("Success creating/accessing IndexedDB database");
                db = request.result;

                db.onerror = function (event) {
                    console.log("Error creating/accessing IndexedDB database");
                };

                // Interim solution for Google Chrome to create an objectStore. Will be deprecated
                if (db.setVersion) {
                    if (db.version != dbVersion) {
                        var setVersion = db.setVersion(dbVersion);
                        setVersion.onsuccess = function () {
                            createObjectStore(db);
                            getImageFile();
                        };
                    }
                    else {
                        getImageFile();
                    }
                }
                else {
                    getImageFile();
                }
            }

            // For future use. Currently only in latest Firefox versions
            request.onupgradeneeded = function (event) {
                createObjectStore(event.target.result);
            };
        })();
    </script>
</body>

</html>