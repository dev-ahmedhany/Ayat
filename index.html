<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <style>
        .img100vh {
            max-height: 100vh;
        }

        .img-page {
            max-width: 50vw;
        }
    </style>
</head>

<body>
    <div class="collapse" id="collapseNavBar">
        <nav class="navbar navbar-expand-lg navbar-light fixed-top bg-light">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">Navbar</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false"
                    aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="navbar-nav">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="flexSwitchCheckDefault">
                        <label class="form-check-label" for="flexSwitchCheckDefault">Full Size</label>
                    </div>
                </div>
            </div>
        </nav>
    </div>
    <div class="container-fluid">
        <div id="myCarousel" class="carousel slide lazy-load" data-bs-interval="false" data-bs-ride="carousel">
            <div class="carousel-inner">
                <div class="carousel-item active">
                    <div class="d-flex flex-row-reverse justify-content-center">
                        <img src="hafs/2.png" alt="2">
                        <img src="hafs/1.png" alt="1">
                    </div>
                </div>
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#myCarousel" data-bs-slide="prev">
                <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#myCarousel" data-bs-slide="next">
                <span class="visually-hidden">Next</span>
            </button>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW"
        crossorigin="anonymous"></script>
    <script>
        //building page
        let inner = "";
        for (let i = 604; i > 2; i = i - 2) {
            inner += `
            <div class="carousel-item">
                <div class="d-flex flex-row-reverse justify-content-center d-inline-block">
                    <img src="hafs/frame.jpg" class="img-page" data-src="hafs/${i}.png" alt="${i}">
                    <img src="hafs/frame.jpg" class="img-page" data-src="hafs/${i - 1}.png" alt="${i - 1}">
                </div>
            </div>`;
        }
        inner += `
            <div class="carousel-item active">
                <div class="d-flex flex-row-reverse justify-content-center">
                    <img src="hafs/2.png" class="img-page" alt="2">
                    <img src="hafs/1.png" class="img-page" alt="1">
                </div>
            </div>`;
        document.querySelector('.carousel-inner').innerHTML = inner;

        //lazy load
        function lazyload(event) {
            event.relatedTarget.querySelectorAll('div > img').forEach(element => {
                if (element.dataset.src) {
                    element.setAttribute('src', element.dataset.src);
                    element.removeAttribute('data-src');
                }
            });
        }
        const myCarousel = document.getElementById('myCarousel');
        myCarousel.addEventListener('slide.bs.carousel', lazyload);
        const carousel = new bootstrap.Carousel(myCarousel, { interval: 0 })
        document.addEventListener('keyup', function (e) {
            if (e.which == 39) {
                carousel.next();
            }
            else if (e.which == 37) {
                carousel.prev();
            }
        });
        //view size
        document.getElementById("flexSwitchCheckDefault").addEventListener("change", () => {
            document.querySelectorAll('.img-page').forEach(element => {
                element.classList.toggle("img100vh");
            });

        })

        // middle click
        document.querySelector('.carousel-inner').addEventListener('click', () => {
            //full screen on click
            let elem = document.documentElement;
            if (elem.requestFullScreen) {
                elem.requestFullScreen();
            } else if (elem.mozRequestFullScreen) {
                elem.mozRequestFullScreen();
            } else if (elem.webkitRequestFullScreen) {
                elem.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT);
            } else if (elem.msRequestFullscreen) {
                elem.msRequestFullscreen();
            }
            //show hide navBar
            let cNavBar = document.getElementById('collapseNavBar');
            cNavBar.className = cNavBar.className == "collapse" ? "collapse show" : "collapse";
        });
    </script>
    <script type="module">
        import { openDB } from 'https://unpkg.com/idb?module';

        if (window.location.protocol == "https:") {
            (async () => {
                'use strict'

                if (!('indexedDB' in window)) {
                    console.warn('IndexedDB not supported')
                    return
                }

                //...IndexedDB code
                const dbName = 'ayat'
                const storeName = 'pages'
                const version = 1 //versions start at 1

                const db = await openDB(dbName, version, {
                    upgrade(db, oldVersion, newVersion, transaction) {
                        db.createObjectStore(storeName)
                    }
                });


                //lazy load
                let lazyloadandsave = async (event) => {
                    event.relatedTarget.querySelectorAll('div > img').forEach(async (element) => {
                        if (element.dataset.src) {

                            const key = element.dataset.src;

                            const item = await db.transaction(storeName).objectStore(storeName).get(key);

                            if (item) {
                                element.setAttribute('src', URL.createObjectURL(item));
                            }
                            else {
                                // Create XHR
                                let xhr = new XMLHttpRequest(), blob;

                                xhr.open("GET", key, true);
                                // Set the responseType to blob
                                xhr.responseType = "blob";

                                xhr.addEventListener("load", async () => {
                                    if (xhr.status === 200) {

                                        // File as response
                                        blob = xhr.response;
                                        element.setAttribute('src', URL.createObjectURL(blob));

                                        // Put the received blob into IndexedDB
                                        const tx = db.transaction(storeName, 'readwrite')
                                        const store = await tx.objectStore(storeName)

                                        const value = await store.put(blob, key)
                                        await tx.done;
                                    }
                                }, false);
                                // Send XHR
                                xhr.send();

                            }

                            element.removeAttribute('data-src');
                        }
                    });
                }
                document.getElementById('myCarousel').removeEventListener('slide.bs.carousel', lazyload);
                document.getElementById('myCarousel').addEventListener('slide.bs.carousel', lazyloadandsave);
            })();

        }

    </script>
</body>

</html>